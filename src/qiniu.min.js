function QiniuJsSDK(){this.isImage=function(a){var b,c="",d=["png","jpg","jpeg","gif","bmp"],e=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!a||!e.test(a))return!1;b=e.exec(a),c=b[1].toLowerCase();for(var f=0,g=d.length;g>f;f++)if(c===d[f])return!0;return!1},this.URLSafeBase64Encode=function(a){return a=mOxie.btoa(a),a.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(){var a={};return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=this.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},this.trim=function(a){return null===a?"":this.trim.call(a)};var a=this;this.uploader=function(b){if(!b.domain)throw"uptoken_url or domain is required!";if(!b.browse_button)throw"browse_button is required!";var c={},d=b.init&&b.init.Error,e=b.init&&b.init.FileUploaded;b.init.Error=function(){},b.init.FileUploaded=function(){},a.uptoken_url=b.uptoken_url,a.token="",a.key_handler="function"==typeof b.init.Key?b.init.Key:"",this.domain=b.domain;var f="",g="http://up.qiniu.com",h=function(){var a,c,d,e="IE"===mOxie.Env.browser&&mOxie.Env.version<=9;e&&b.chunk_size&&b.runtimes.indexOf("flash")>=0?b.chunk_size=0:(a=20,c=4<<a,d=plupload.parseSize(b.chunk_size),d>c&&(b.chunk_size=c))};h();var i=function(){if(b.uptoken)a.token=b.uptoken;else{var c=a.createAjax();c.open("GET",a.uptoken_url,!0),c.setRequestHeader("If-Modified-Since","0"),c.onreadystatechange=function(){if(4===c.readyState&&200===c.status){var b=a.parseJSON(c.responseText);a.token=b.uptoken}},c.send()}},j=function(a,b){var c=a.getOption&&a.getOption(b);return c=c||a.settings&&a.settings[b]},k=function(a,c,d){var e="",f=!1;if(!b.save_key)if(f=j(a,"unique_names")){var g=mOxie.Mime.getFileExtension(c.name);e=g?c.id+"."+g:c.id}else e="function"==typeof d?d(a,c):c.name;return e};plupload.extend(c,b,{url:g,multipart_params:{token:""}});var l=new plupload.Uploader(c);return l.bind("Init",function(){i()}),l.init(),l.bind("FilesAdded",function(a,b){var c=j(a,"auto_start");c&&$.each(b,function(){a.start()}),a.refresh()}),l.bind("BeforeUpload",function(c,d){f="";var e=function(c,d,e){var f;f=b.save_key?{token:a.token}:{key:k(c,d,e),token:a.token};var h=b.x_vars;if(void 0!==h&&"object"==typeof h)for(var i in h)h.hasOwnProperty(i)&&("function"==typeof h[i]?f["x:"+i]=h[i](c,d):"object"!=typeof h[i]&&(f["x:"+i]=h[i]));c.setOption({url:g,multipart:!0,chunk_size:void 0,multipart_params:f})},h=function(b,c){var d=localStorage.getItem(c.name),e=i;if(d){d=JSON.parse(d);var h=(new Date).getTime(),j=d.time||0,k=864e5;k>h-j&&100!==d.percent?(c.percent=d.percent,c.loaded=d.offset,f=d.ctx,d.offset+e>c.size&&(e=c.size-d.offset)):localStorage.removeItem(c.name)}b.setOption({url:g+"/mkblk/"+e,multipart:!1,chunk_size:i,required_features:"chunks",headers:{Authorization:"UpToken "+a.token},multipart_params:{}})},i=j(c,"chunk_size");"html5"===l.runtime&&i?d.size<i?e(c,d,a.key_handler):h(c,d):e(c,d,a.key_handler)}),l.bind("ChunkUploaded",function(b,c,d){var e=function(a){localStorage.setItem(a.name,JSON.stringify({ctx:f,percent:a.percent,total:d.total,offset:d.offset,time:(new Date).getTime()}))},h=a.parseJSON(d.response);f=f?f+","+h.ctx:h.ctx;var i=d.total-d.offset,k=j(b,"chunk_size");k>i&&b.setOption({url:g+"/mkblk/"+i}),e(c)}),l.bind("Error",function(b,c){var e="",f=c.file;if(f){switch(c.code){case plupload.FAILED:e="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var g=j(b,"max_file_size");e="浏览器最大可上传"+g+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:e="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:var h=a.parseJSON(c.response),i=h.error;switch(c.status){case 400:e="请求报文格式错误。";break;case 401:e="客户端认证授权失败。请重试或提交反馈。";break;case 405:e="客户端请求错误。请重试或提交反馈。";break;case 579:e="资源上传成功，但回调失败。";break;case 599:e="网络连接异常。请重试或提交反馈。";break;case 614:e="文件已存在。";try{h=a.parseJSON(h.error),i=h.error||"file exists"}catch(k){i=h.error||"file exists"}break;case 631:e="指定空间不存在。";break;case 701:e="上传数据块校验出错。请重试或提交反馈。";break;default:e="未知错误。"}e=e+"("+c.status+"："+i+")";break;case plupload.SECURITY_ERROR:e="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:e="上传失败。请稍后再试。";break;case plupload.IO_ERROR:e="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:e="网站配置错误。请联系网站管理员。",l.destroy();break;default:e=c.message+c.details}d&&d(b,c,e)}b.refresh()}),l.bind("FileUploaded",function(c,d,h){var i=function(a){var e="";b.save_key||(e=k(c,d,a.key_handler),e=e?"/key/"+a.URLSafeBase64Encode(e):"");var h=j(),i=g+"/mkfile/"+d.size+e+h,n=a.createAjax();n.open("POST",i,!0),n.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),n.setRequestHeader("Authorization","UpToken "+a.token),n.onreadystatechange=function(){if(4===n.readyState)if(localStorage.removeItem(d.name),200===n.status){var a=n.responseText;m(c,d,a)}else l.trigger("Error",{status:n.status,response:n.responseText,file:d,code:-200})},n.send(f)},j=function(){var e=b.x_vars,f="",g="";if(void 0!==e&&"object"==typeof e)for(var h in e)e.hasOwnProperty(h)&&("function"==typeof e[h]?f=a.URLSafeBase64Encode(e[h](c,d)):"object"!=typeof e[h]&&(f=a.URLSafeBase64Encode(e[h])),g+="/x:"+h+"/"+f);return g},m=function(c,d,f){b.downtoken_url?n(a):e&&e(c,d,f)},n=function(a){var f=a.createAjax();f.open("POST",b.downtoken_url,!0),f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.onreadystatechange=function(){if(4===f.readyState)if(200===f.status){var b;try{b=a.parseJSON(f.responseText)}catch(g){throw"invalid json format"}var i={};plupload.extend(i,a.parseJSON(h),b),e&&e(c,d,JSON.stringify(i))}else l.trigger("Error",{status:f.status,response:f.responseText,file:d,code:plupload.HTTP_ERROR})},f.send("key="+a.parseJSON(h).key+"&domain="+b.domain)},o=a.parseJSON(h.response);f=f?f:o.ctx,f?i(a):m(c,d,h.response)}),l},this.getUrl=function(a){if(!a)return!1;a=encodeURI(a);var b=this.domain;return"/"!==b.slice(b.length-1)&&(b+="/"),b+a}}